<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Daily Activity — Timetable</title>
  <meta name="description" content="Daily timetable with interactive donut chart." />

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      /* Core Colors - Dark Slate Theme */
      --bg-body: #0b1117;
      --bg-card: #131d26;
      --bg-modal: #16202a;
      --bg-input: rgba(0, 0, 0, 0.2);
      
      --text-main: #eef3f7;
      --text-muted: #8b9bb4;
      
      --accent-primary: #38bdf8;   /* Sky Blue */
      --accent-secondary: #2dd4bf; /* Teal */
      --danger: #fb7185;           /* Soft Red */
      --success: #4ade80;          /* Soft Green */

      /* Spacing & Shape */
      --radius-lg: 20px;
      --radius-md: 12px;
      --radius-sm: 8px;
      
      /* Animation - "The Silky Curve" */
      --ease-elastic: cubic-bezier(0.2, 0.8, 0.2, 1);
      --duration-slow: 600ms;
      --duration-fast: 250ms;

      --max-content-width: 1200px;
    }

    /* -- Base Reset ----------------------------------------------------------*/
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg-body);font-family:'Inter',sans-serif;color:var(--text-main);-webkit-font-smoothing:antialiased}
    button{font-family:inherit; user-select:none;}
    a{color:inherit;text-decoration:none}
    
    /* Scrollbar Polish */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }

    /* Icons */
    .icon{width:20px;height:20px;fill:none;stroke:currentColor;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}

    /* -- Layout & Container --------------------------------------------------*/
    .container{max-width:var(--max-content-width);margin:0 auto;padding:24px; min-height:100vh; display:flex; flex-direction:column;}
    
    /* Header */
    .top{display:flex;align-items:center;justify-content:space-between;gap:20px; margin-bottom:32px;}
    .brand{display:flex;align-items:center;gap:16px}
    .logo{width:48px;height:48px;border-radius:14px;display:grid;place-items:center;background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));font-weight:800;color:#0f172a;box-shadow:0 8px 20px rgba(56, 189, 248, 0.25)}
    h1{margin:0;font-size:22px;font-weight:700;letter-spacing:-0.5px}

    /* Controls */
    .controls{display:flex;gap:16px;align-items:center}
    
    /* Buttons */
    .btn{background:linear-gradient(90deg,var(--accent-primary),var(--accent-secondary));border:none;color:#0f172a;padding:10px 20px;border-radius:var(--radius-md);cursor:pointer;font-weight:700;font-size:14px;transition:transform 0.1s, filter 0.2s}
    .btn:hover{filter:brightness(1.1)}
    .btn:active{transform:scale(0.96)}
    .btn:disabled{opacity:0.5;cursor:not-allowed;filter:grayscale(1)}
    
    .ghost{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);padding:8px 12px;border-radius:var(--radius-md);color:var(--text-muted);cursor:pointer;display:inline-flex;align-items:center;justify-content:center;transition:all 0.2s}
    .ghost:hover{background:rgba(255,255,255,0.08); color:var(--text-main); border-color:rgba(255,255,255,0.2)}
    .ghost:active{transform:scale(0.96)}
    .ghost:disabled{opacity:0.3; pointer-events:none}

    .icon-btn{width:44px;height:44px;padding:0;border-radius:50%;}
    
    /* -- Toggle Switch (Softer) ----------------------------------------------*/
    .toggle-wrapper { display:flex; align-items:center; gap:10px; cursor:pointer; padding:6px 12px; background:rgba(255,255,255,0.03); border-radius:30px; border:1px solid rgba(255,255,255,0.05); transition:background 0.2s }
    .toggle-wrapper:hover { background:rgba(255,255,255,0.06); }
    .toggle-label { font-size:13px; font-weight:600; color:var(--text-muted); }
    
    .switch {position: relative; display: inline-block; width: 40px; height: 22px;}
    .switch input {opacity: 0; width: 0; height: 0;}
    .slider {position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #334155; transition: var(--duration-fast) var(--ease-elastic); border-radius: 24px;}
    .slider:before {position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: var(--duration-fast) var(--ease-elastic); border-radius: 50%; box-shadow:0 2px 4px rgba(0,0,0,0.2)}
    input:checked + .slider {background-color: var(--accent-secondary);}
    input:checked + .slider:before {transform: translateX(18px);}

    /* -- Main Grid Layout (The Silky Transition) -----------------------------*/
    main {
      display:grid;
      grid-template-columns: 1fr 340px;
      gap: 32px;
      align-items: stretch;
      flex:1;
      transition: grid-template-columns var(--duration-slow) var(--ease-elastic), gap var(--duration-slow) var(--ease-elastic);
    }
    
    /* Legend Hidden State */
    main.full-width { grid-template-columns: 1fr 0px; gap:0; }

    @media (max-width:900px){ main, main.full-width{grid-template-columns:1fr; gap:24px} .aside{order:2; opacity:1 !important; pointer-events:auto !important} }

    /* -- Card Styling --------------------------------------------------------*/
    .card{
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: 24px;
      box-shadow: 0 20px 50px -10px rgba(0,0,0,0.3);
      display:flex; flex-direction:column;
      border: 1px solid rgba(255,255,255,0.03);
      overflow:hidden;
      position:relative;
    }

    /* -- Chart Area ----------------------------------------------------------*/
    .chart-container {
      flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; 
      position:relative; min-height:500px;
    }
    
    svg { overflow: visible; outline: none !important; }
    path { outline: none !important; cursor: pointer; transform-origin: center; }
    
    .donut {
      width: 100%;
      max-width: 460px; 
      aspect-ratio: 1/1;
      /* Smooth resizing when layout changes */
      transition: max-width var(--duration-slow) var(--ease-elastic);
    }
    
    /* Center Logic: When legend hidden, chart stays reasonable size */
    main.full-width .donut { max-width: 540px; }

    .center-text{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);display:flex;flex-direction:column;align-items:center;text-align:center;pointer-events:none; z-index:10}
    .center-text .val{font-size:32px;font-weight:800;letter-spacing:-1px; line-height:1; background:linear-gradient(to bottom, #fff, #cbd5e1); -webkit-background-clip:text; -webkit-text-fill-color:transparent;}
    .center-text .lbl{font-size:12px;color:var(--text-muted);margin-top:6px;text-transform:uppercase;letter-spacing:1.5px;font-weight:600}

    /* -- Legend --------------------------------------------------------------*/
    .aside {
      display:flex; flex-direction:column; 
      transition: opacity var(--duration-fast) ease, transform var(--duration-slow) var(--ease-elastic);
      opacity:1; transform:translateX(0);
      min-width: 340px; /* Prevent squishing during animation */
    }
    
    main.full-width .aside { opacity:0; transform:translateX(20px); pointer-events:none; overflow:hidden; min-width:0; }

    .legend-scroll{ flex:1; overflow-y:auto; padding-right:4px; display:flex; flex-direction:column; gap:6px; max-height: 60vh; }
    
    .legend-row {
      display:flex; align-items:center; gap:14px; padding:12px 16px; 
      border-radius: var(--radius-md); cursor:pointer; user-select:none;
      border:1px solid transparent; transition: all 0.2s;
    }
    .legend-row:hover, .legend-row.highlight { background:rgba(255,255,255,0.04); border-color:rgba(255,255,255,0.05); transform:scale(1.01); }
    .swatch { width:12px; height:12px; border-radius:4px; flex-shrink:0; box-shadow:0 0 10px rgba(0,0,0,0.2) }
    .l-label { font-weight:500; font-size:14px; color:var(--text-main); flex:1 }
    .l-meta { font-size:13px; color:var(--text-muted); font-variant-numeric: tabular-nums; }

    /* -- Detail Floating Panel -----------------------------------------------*/
    .detail {
      position:fixed; left:50%; bottom:32px; 
      transform: translateX(-50%) translateY(20px); opacity:0;
      min-width:300px; padding:16px 20px;
      background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(16px);
      border: 1px solid rgba(255,255,255,0.1); border-radius: var(--radius-lg);
      box-shadow: 0 20px 60px rgba(0,0,0,0.6);
      display:flex; gap:16px; align-items:center;
      z-index: 100; pointer-events:none;
      transition: opacity 0.2s, transform 0.4s var(--ease-elastic);
    }
    .detail.visible { opacity:1; transform: translateX(-50%) translateY(0); pointer-events:auto; }
    
    .d-bar { width:4px; height:40px; border-radius:2px; background:#fff; }
    .d-info { display:flex; flex-direction:column; }
    .d-title { font-weight:700; font-size:15px; color:#fff; }
    .d-time { font-size:13px; color:var(--text-muted); margin-top:2px; }
    .d-stat { margin-left:auto; text-align:right; }
    .d-hrs { font-weight:700; font-size:18px; color:var(--accent-primary); }
    .d-pct { font-size:12px; color:var(--text-muted); }

    /* -- Modal (Customize) ---------------------------------------------------*/
    .backdrop {
      position:fixed; inset:0; background:rgba(0,0,0,0.6); backdrop-filter:blur(6px);
      z-index:1000; display:flex; align-items:center; justify-content:center;
      opacity:0; pointer-events:none; transition: opacity 0.3s ease;
    }
    .backdrop.open { opacity:1; pointer-events:auto; }
    
    .modal {
      width:90%; max-width:900px; max-height:85vh;
      background: var(--bg-modal);
      border: 1px solid rgba(255,255,255,0.08); border-radius: 24px;
      box-shadow: 0 40px 80px rgba(0,0,0,0.8);
      display:flex; flex-direction:column;
      transform: scale(0.95) translateY(10px); transition: transform 0.4s var(--ease-elastic);
      overflow: hidden; /* Keeps rounded corners clean */
    }
    .backdrop.open .modal { transform: scale(1) translateY(0); }
    
    .m-header { padding:24px 32px; border-bottom:1px solid rgba(255,255,255,0.05); display:flex; justify-content:space-between; align-items:center; background:rgba(0,0,0,0.2) }
    .m-body { padding: 0 32px; overflow-y:auto; flex:1; }
    .m-footer { padding:20px 32px; border-top:1px solid rgba(255,255,255,0.05); display:flex; justify-content:space-between; align-items:center; background:rgba(0,0,0,0.2) }

    /* Manage Table */
    .manage-list { display:flex; flex-direction:column; gap:8px; padding-top:24px; padding-bottom:24px; }
    .m-row { display:grid; grid-template-columns: 1fr 100px 100px 60px 50px 40px; gap:12px; align-items:center; padding:8px; border-radius:10px; transition:background 0.2s; border:1px solid transparent }
    .m-row:hover { background:rgba(255,255,255,0.02); border-color:rgba(255,255,255,0.03) }
    
    .m-head { font-size:11px; text-transform:uppercase; letter-spacing:1px; color:var(--text-muted); font-weight:700; padding:0 8px; margin-bottom:4px; display:grid; grid-template-columns: 1fr 100px 100px 60px 50px 40px; gap:12px; }

    /* Inputs */
    input {
      width:100%; background:var(--bg-input); border:1px solid transparent;
      color:var(--text-main); padding:8px 12px; border-radius:8px;
      font-family:inherit; font-size:14px; font-weight:500; outline:none;
      transition: all 0.2s;
    }
    input:hover { background:rgba(255,255,255,0.05); }
    input:focus { background:rgba(0,0,0,0.4); border-color:var(--accent-primary); }
    input:disabled { color:var(--text-muted); background:transparent; text-align:right; padding-right:0; }

    .color-pick { width:32px; height:32px; border-radius:8px; cursor:pointer; border:2px solid rgba(255,255,255,0.1); position:relative; overflow:hidden; transition:transform 0.2s var(--ease-elastic); }
    .color-pick:active { transform:scale(0.85); }
    .color-pick input { position:absolute; top:-50%; left:-50%; width:200%; height:200%; opacity:0; cursor:pointer; }

    /* Popups (Menus) */
    .popup-menu {
      display:none; position:absolute; bottom:120%; left:0;
      width: 220px; background: #1e293b; 
      border: 1px solid rgba(255,255,255,0.1); border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      padding: 6px; z-index: 2000;
      transform-origin: bottom left; animation: popIn 0.2s var(--ease-elastic);
    }
    /* Align export menu to right if needed */
    .popup-menu.right { left:auto; right:0; transform-origin: bottom right; }

    @keyframes popIn { from{opacity:0; transform:scale(0.9) translateY(10px)} to{opacity:1; transform:scale(1) translateY(0)} }

    .menu-item {
      display:flex; align-items:center; gap:10px; width:100%;
      text-align:left; background:transparent; border:none;
      color:var(--text-main); padding:10px 12px; border-radius:8px;
      font-size:13px; transition:background 0.1s;
    }
    .menu-item:hover { background:rgba(255,255,255,0.08); }
    .menu-item.danger { color:var(--danger); }
    .menu-item.danger:hover { background:rgba(251, 113, 133, 0.1); }
    .menu-sep { height:1px; background:rgba(255,255,255,0.1); margin:4px 8px; }

    .error-toast { 
      background: rgba(251, 113, 133, 0.1); border:1px solid rgba(251, 113, 133, 0.2);
      color: var(--danger); padding:12px; border-radius:12px; 
      margin-top:16px; text-align:center; font-size:13px; font-weight:600;
      display:none; animation: shake 0.4s ease;
    }
    @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-4px)} 75%{transform:translateX(4px)} }

    /* Mobile */
    @media(max-width:768px){
      .m-row { grid-template-columns: 1fr 70px 70px; grid-template-rows: auto auto; row-gap:8px; }
      .m-head { display:none; }
      /* Hide less important columns on mobile or stack them */
      .m-row > *:nth-child(4), .m-row > *:nth-child(5), .m-row > *:nth-child(6) { grid-row:2; } 
      .m-row > *:nth-child(1) { grid-column: 1 / -1; }
      .popup-menu { position:fixed; bottom:0; left:0; width:100%; border-radius:20px 20px 0 0; transform-origin: bottom center; }
    }

  </style>
</head>

<body>
  <div class="container">
    
    <header class="top">
      <div class="brand">
        <div class="logo" title="Daily Activity">DA</div>
        <div>
          <h1>Daily Activity</h1>
          <div style="font-size:13px; color:var(--text-muted)">24h Planner</div>
        </div>
      </div>

      <div class="controls">
        <div class="toggle-wrapper" onclick="document.getElementById('legendToggle').click()">
          <span class="toggle-label">Legend</span>
          <label class="switch">
            <input type="checkbox" id="legendToggle" checked>
            <span class="slider"></span>
          </label>
        </div>

        <button id="openSettings" class="ghost icon-btn" title="Customize">
          <svg class="icon" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
        </button>
        
        <button id="help" class="ghost icon-btn" title="Help">?</button>
      </div>
    </header>

    <main id="mainLayout">
      <section class="card">
        <div class="chart-container">
          <svg id="donut" class="donut" viewBox="0 0 420 420"></svg>
          <div class="center-text">
            <div id="centerTotal" class="val">0h</div>
            <div id="centerSub" class="lbl">Scheduled</div>
          </div>
        </div>
      </section>

      <aside id="legendAside" class="aside">
        <div class="card" style="height:100%">
          <h3 style="margin:0 0 16px 0; font-size:12px; color:var(--text-muted); text-transform:uppercase; letter-spacing:1.5px;">Legend</h3>
          <div id="legend" class="legend-scroll"></div>
        </div>
      </aside>
    </main>

  </div>

  <div id="detail" class="detail">
    <div id="detailSw" class="d-bar"></div>
    <div class="d-info">
      <div id="detailTitle" class="d-title"></div>
      <div id="detailTime" class="d-time"></div>
    </div>
    <div class="d-stat">
      <div id="detailHours" class="d-hrs"></div>
      <div id="detailPct" class="d-pct"></div>
    </div>
  </div>

  <div id="backdrop" class="backdrop">
    <div class="modal">
      
      <div class="m-header">
        <div>
          <h2 style="margin:0; font-size:20px;">Customize</h2>
          <div id="modalTotal" style="font-size:13px; color:var(--text-muted); margin-top:4px">Total: 0h / 24h</div>
        </div>
        <div style="display:flex; gap:12px; align-items:center">
          <button id="undoBtn" class="ghost icon-btn" style="width:36px;height:36px" disabled title="Undo (Ctrl+Z)">
             <svg class="icon" viewBox="0 0 24 24"><path d="M3 7v6h6"></path><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"></path></svg>
          </button>
          <button id="redoBtn" class="ghost icon-btn" style="width:36px;height:36px" disabled title="Redo (Ctrl+Y)">
             <svg class="icon" viewBox="0 0 24 24"><path d="M21 7v6h-6"></path><path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3L21 13"></path></svg>
          </button>
          <button id="closeSave" class="btn">Done</button>
        </div>
      </div>

      <div class="m-body">
        <div style="display:flex; gap:12px; margin:24px 0;" id="palettes"></div>
        
        <div class="m-head">
          <div>Activity</div>
          <div>Start</div>
          <div>End</div>
          <div style="text-align:right">Hrs</div>
          <div style="text-align:center">Color</div>
          <div></div>
        </div>

        <div id="manageBody" class="manage-list"></div>

        <button id="createRow" class="ghost" style="width:100%; border-style:dashed; color:var(--accent-primary); margin-bottom:12px">
          + Add New Activity
        </button>

        <div id="timeError" class="error-toast">
          ⚠️ Total time cannot exceed 24 hours. Please adjust durations.
        </div>
      </div>

      <div class="m-footer">
        <div style="position:relative">
          <button id="resetBtn" class="ghost">Reset / Defaults ▾</button>
          <div id="resetMenu" class="popup-menu">
            <button class="menu-item" id="resetToDefault">Reset to My Default</button>
            <button class="menu-item" id="resetToFactory">Reset to Factory</button>
            <div class="menu-sep"></div>
            <button class="menu-item" id="setAsDefault" style="color:var(--accent-secondary)">Set Current as Default</button>
            <div class="menu-sep"></div>
            <button class="menu-item danger" id="clearAll">Clear All (Empty)</button>
          </div>
        </div>

        <div style="position:relative">
          <button id="exportBtn" class="ghost">Export Data ▾</button>
          <div id="exportMenu" class="popup-menu right">
            <button class="menu-item" id="exportPNG">PNG Image</button>
            <button class="menu-item" id="exportSVG">SVG Vector</button>
            <button class="menu-item" id="exportCSV">CSV File</button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <div id="live" class="sr-only" aria-live="polite"></div>

<script>
(() => {
  // ---- Config ----------------------------------------------------------
  const FACTORY_DEFAULT = [
    { label: 'Sleep', start: '22:30', end: '05:30', hours: 7 },
    { label: 'Morning Routine', start: '05:30', end: '06:00', hours: 0.5 },
    { label: 'Meditation', start: '06:00', end: '06:30', hours: 0.5 },
    { label: 'Study', start: '06:30', end: '08:30', hours: 2 },
    { label: 'Work', start: '08:30', end: '12:30', hours: 4 },
    { label: 'Lunch', start: '12:30', end: '13:30', hours: 1 },
    { label: 'Work', start: '13:30', end: '17:30', hours: 4 },
    { label: 'Exercise', start: '17:30', end: '18:30', hours: 1 },
    { label: 'Dinner', start: '18:30', end: '19:30', hours: 1 },
    { label: 'Free Time', start: '19:30', end: '22:30', hours: 3 }
  ];
  
  const KEYS = { items: 'da-items-v4', settings: 'da-settings-v4', userDefault: 'da-user-def-v1' };

  // ---- DOM Refs --------------------------------------------------------
  const $ = (id) => document.getElementById(id);
  const els = {
    svg: $('donut'), legend: $('legend'), legendAside: $('legendAside'),
    main: $('mainLayout'), centerTotal: $('centerTotal'), centerSub: $('centerSub'),
    detail: $('detail'), detailSw: $('detailSw'), detailTitle: $('detailTitle'),
    detailTime: $('detailTime'), detailHours: $('detailHours'), detailPct: $('detailPct'),
    live: $('live'),
    settingsBtn: $('openSettings'), toggle: $('legendToggle'), helpBtn: $('help'),
    backdrop: $('backdrop'), closeSave: $('closeSave'), createRow: $('createRow'),
    manageList: $('manageBody'), palettes: $('palettes'), errToast: $('timeError'),
    modalTotal: $('modalTotal'), undoBtn: $('undoBtn'), redoBtn: $('redoBtn'),
    exportBtn: $('exportBtn'), exportMenu: $('exportMenu'),
    resetBtn: $('resetBtn'), resetMenu: $('resetMenu'),
    // Actions
    exPng: $('exportPNG'), exSvg: $('exportSVG'), exCsv: $('exportCSV'),
    rDef: $('resetToDefault'), rFac: $('resetToFactory'), rSet: $('setAsDefault'), rClear: $('clearAll')
  };

  // ---- State -----------------------------------------------------------
  let items = load(KEYS.items) || JSON.parse(JSON.stringify(FACTORY_DEFAULT));
  let settings = load(KEYS.settings) || { palette: getPaletteCSS().slice() };
  let detailPinned = false;
  const history = [];
  let historyPtr = -1;
  let isUndoing = false;

  // ---- Helpers ---------------------------------------------------------
  function save(k,v){ try{localStorage.setItem(k,JSON.stringify(v))}catch(e){} }
  function load(k){ try{return JSON.parse(localStorage.getItem(k))}catch(e){return null} }
  function announce(m){ els.live.textContent=m; setTimeout(()=>els.live.textContent='',1400); }
  function getPaletteCSS(){ 
    const p = getComputedStyle(document.documentElement).getPropertyValue('--palette');
    return p ? p.split(',').filter(Boolean).map(s=>s.trim()) : ['#38bdf8','#2dd4bf','#fb7185','#facc15','#a78bfa'];
  }
  function colorFor(i){ 
    const p = (settings.palette && settings.palette.length) ? settings.palette : getPaletteCSS();
    return items[i].color || p[i % p.length];
  }
  function toMins(v){ if(!v)return null; const [h,m]=v.split(':'); return Number(h)*60+Number(m); }
  function toStr(n){ n=(Math.round(n)%(24*60)); if(n<0)n+=24*60; const h=Math.floor(n/60), m=n%60; return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`; }
  function fmtTime(m){ if(m==null)return ''; const h=Math.floor(m/60), mn=m%60, am=h<12?'AM':'PM', h12=h%12||12; return `${h12}:${String(mn).padStart(2,'0')} ${am}`; }
  function calcDur(s,e){ 
    if(!s||!e) return 0; 
    let d = toMins(e) - toMins(s); 
    if(d<0) d += 24*60; 
    return Math.round((d/60)*100)/100; 
  }

  // ---- Core Logic ------------------------------------------------------
  function pushHistory(){
    if(isUndoing) return;
    if(historyPtr < history.length-1) history.splice(historyPtr+1);
    history.push(JSON.stringify(items));
    if(history.length>50) history.shift(); else historyPtr++;
    updateUndoUI();
  }
  function updateUndoUI(){ els.undoBtn.disabled = historyPtr<=0; els.redoBtn.disabled = historyPtr>=history.length-1; }
  function undo(){ if(historyPtr>0){ isUndoing=true; historyPtr--; items=JSON.parse(history[historyPtr]); refreshAll(); isUndoing=false; updateUndoUI(); } }
  function redo(){ if(historyPtr<history.length-1){ isUndoing=true; historyPtr++; items=JSON.parse(history[historyPtr]); refreshAll(); isUndoing=false; updateUndoUI(); } }

  function refreshAll(){
    drawDonut(); renderLegend(); renderManage(); 
    // Validation check
    const total = items.reduce((s,i)=>s+(Number(i.hours)||0),0);
    const rTotal = Math.round((total+Number.EPSILON)*100)/100;
    if(rTotal>24){
      els.centerTotal.textContent='!'; els.centerTotal.style.color='var(--danger)'; els.centerSub.textContent='Limit Exceeded';
    } else {
      els.centerTotal.textContent=`${rTotal}h`; els.centerTotal.style.color='var(--text-main)'; els.centerSub.textContent='Scheduled';
    }
  }

  // ---- Rendering -------------------------------------------------------
  function drawDonut(){
    while(els.svg.firstChild) els.svg.removeChild(els.svg.firstChild);
    const r=180, cx=210, cy=210;
    const total = items.reduce((s,i)=>s+(Number(i.hours)||0),0);
    
    // Empty State
    if(total<=0.001){
      const bg = createSVG('circle',{cx,cy,r,fill:'none',stroke:'rgba(255,255,255,0.05)','stroke-width':16});
      els.svg.append(bg); return;
    }

    let ang = -90;
    items.forEach((it,i)=>{
      const val = Number(it.hours)||0; if(val<=0)return;
      const sweep = (val/24)*360;
      const end = ang + sweep;
      const p1 = polar(cx,cy,r,ang), p2 = polar(cx,cy,r,end);
      const large = sweep>180?1:0;
      const d = `M ${cx} ${cy} L ${p1.x} ${p1.y} A ${r} ${r} 0 ${large} 1 ${p2.x} ${p2.y} Z`;
      const path = createSVG('path',{d, fill:colorFor(i), 'data-idx':i});
      
      // Event Listeners
      path.onmouseenter = () => { interact(i); };
      path.onmouseleave = () => { interact(null); };
      path.onclick = (e) => { e.stopPropagation(); detailPinned=!detailPinned; };
      
      els.svg.append(path);
      ang = end;
    });

    // Unallocated
    if(total<24){
      const sweep = ((24-total)/24)*360;
      const end = ang + sweep;
      const p1 = polar(cx,cy,r,ang), p2 = polar(cx,cy,r,end);
      const large = sweep>180?1:0;
      const d = `M ${cx} ${cy} L ${p1.x} ${p1.y} A ${r} ${r} 0 ${large} 1 ${p2.x} ${p2.y} Z`;
      els.svg.append(createSVG('path',{d, fill:'rgba(255,255,255,0.03)', style:'pointer-events:none'}));
    }
    // Hole
    els.svg.append(createSVG('circle',{cx,cy,r:100,fill:'#131d26'}));
  }

  function createSVG(t,a){ const e=document.createElementNS('http://www.w3.org/2000/svg',t); for(const k in a)e.setAttribute(k,a[k]); return e; }
  function polar(cx,cy,r,deg){ const rad=(deg-90)*Math.PI/180; return {x:cx+r*Math.cos(rad), y:cy+r*Math.sin(rad)}; }

  function interact(idx){
    const paths = Array.from(els.svg.querySelectorAll('path[data-idx]'));
    const rows = Array.from(els.legend.children);
    
    // Reset
    if(idx===null && !detailPinned){
      paths.forEach(p=>{ p.style.transform='scale(1)'; p.style.opacity='1'; });
      rows.forEach(r=>r.classList.remove('highlight'));
      els.detail.classList.remove('visible');
      return;
    }
    if(idx===null) return; // Pinned, don't clear

    // Active State
    paths.forEach(p=>{
      const i = parseInt(p.getAttribute('data-idx'));
      if(i===idx){ p.style.transform='scale(1.05)'; p.style.opacity='1'; p.style.zIndex='10'; }
      else { p.style.transform='scale(1)'; p.style.opacity='0.3'; }
    });
    rows.forEach(r=>{
       if(parseInt(r.getAttribute('data-idx'))===idx) { r.classList.add('highlight'); r.scrollIntoView({block:'nearest',behavior:'smooth'}); }
       else r.classList.remove('highlight');
    });

    // Update Detail
    const it = items[idx];
    els.detailSw.style.background = colorFor(idx);
    els.detailTitle.textContent = it.label || 'Activity';
    els.detailTime.textContent = `${fmtTime(toMins(it.start))} - ${fmtTime(toMins(it.end))}`;
    els.detailHours.textContent = `${it.hours}h`;
    els.detailPct.textContent = `${Math.round((it.hours/24)*100)}%`;
    els.detail.classList.add('visible');
  }

  function renderLegend(){
    els.legend.innerHTML='';
    items.forEach((it,i)=>{
      const row = document.createElement('div'); row.className='legend-row'; row.setAttribute('data-idx',i);
      row.onmouseenter = ()=>interact(i);
      row.onmouseleave = ()=>interact(null);
      row.onclick = (e)=>{ e.stopPropagation(); interact(i); detailPinned=true; };
      
      row.innerHTML = `<div class="swatch" style="background:${colorFor(i)}"></div>
                       <div class="l-label">${it.label}</div>
                       <div class="l-meta">${it.hours}h</div>`;
      els.legend.append(row);
    });
  }

  // ---- Settings Panel --------------------------------------------------
  function renderManage(){
    els.manageList.innerHTML='';
    let total=0;
    items.forEach((it,i)=>{
      total+=Number(it.hours)||0;
      const row = document.createElement('div'); row.className='m-row';
      
      // Label
      const inpLbl = document.createElement('input'); inpLbl.value=it.label;
      inpLbl.oninput=(e)=>items[i].label=e.target.value; inpLbl.onchange=pushHistory;
      
      // Start
      const inpS = document.createElement('input'); inpS.type='time'; inpS.value=it.start;
      inpS.onchange=(e)=>{ items[i].start=e.target.value; recalc(i); pushHistory(); refreshAll(); };
      
      // End
      const inpE = document.createElement('input'); inpE.type='time'; inpE.value=it.end;
      inpE.onchange=(e)=>{ items[i].end=e.target.value; recalc(i); pushHistory(); refreshAll(); };
      
      // Hours
      const inpH = document.createElement('input'); inpH.disabled=true; inpH.value=it.hours;
      
      // Color
      const colWrap = document.createElement('div'); colWrap.className='color-pick'; 
      colWrap.style.background=it.color||colorFor(i);
      const inpC = document.createElement('input'); inpC.type='color';
      inpC.oninput=(e)=>{ items[i].color=e.target.value; colWrap.style.background=e.target.value; };
      inpC.onchange=pushHistory; 
      colWrap.append(inpC);

      // Delete
      const btnDel = document.createElement('button'); btnDel.className='ghost icon-btn'; 
      btnDel.style.width='32px'; btnDel.style.height='32px'; btnDel.style.color='var(--text-muted)';
      btnDel.innerHTML=`<svg class="icon" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>`;
      btnDel.onclick=()=>{ items.splice(i,1); refreshAll(); pushHistory(); };
      btnDel.onmouseover=()=>btnDel.style.color='var(--danger)';
      btnDel.onmouseout=()=>btnDel.style.color='var(--text-muted)';

      row.append(inpLbl, inpS, inpE, inpH, colWrap, btnDel);
      els.manageList.append(row);
    });
    
    const rTotal = Math.round((total+Number.EPSILON)*100)/100;
    els.modalTotal.textContent = `Total: ${rTotal}h / 24h`;
    els.modalTotal.style.color = rTotal>24 ? 'var(--danger)' : 'var(--text-muted)';
    els.errToast.style.display = rTotal>24 ? 'block' : 'none';
    els.closeSave.disabled = rTotal>24;
  }

  function recalc(i){
    if(!items[i].start) return;
    if(!items[i].end) items[i].end = toStr(toMins(items[i].start)+60);
    items[i].hours = calcDur(items[i].start, items[i].end);
  }

  function renderPalettes(){
    els.palettes.innerHTML='';
    const sets = [
      ['#38bdf8','#2dd4bf','#fb7185','#facc15','#a78bfa','#94a3b8'],
      ['#60a5fa','#34d399','#f87171','#fbbf24','#818cf8','#a1a1aa'],
      ['#22d3ee','#4ade80','#f472b6','#fb923c','#c084fc','#cbd5e1']
    ];
    sets.forEach(p=>{
      const btn = document.createElement('button'); btn.className='ghost'; btn.style.padding='6px';
      const ctr = document.createElement('div'); ctr.style.display='flex'; ctr.style.gap='4px';
      p.forEach(c=>{ const d=document.createElement('div'); d.style.width='12px'; d.style.height='12px'; d.style.borderRadius='50%'; d.style.background=c; ctr.append(d); });
      btn.append(ctr);
      btn.onclick=()=>{ settings.palette=p; items.forEach((it,x)=>it.color=p[x%p.length]); save(KEYS.settings,settings); refreshAll(); pushHistory(); announce('Theme Updated'); };
      els.palettes.append(btn);
    });
  }

  // ---- Events ----------------------------------------------------------
  els.toggle.onchange = (e) => {
    if(e.target.checked) { els.legendAside.classList.remove('hidden'); els.main.classList.remove('full-width'); }
    else { els.legendAside.classList.add('hidden'); els.main.classList.add('full-width'); }
    setTimeout(drawDonut, 600); // Wait for animation
  };

  els.settingsBtn.onclick = () => { 
    if(history.length===0) pushHistory();
    els.backdrop.classList.add('open'); renderManage(); renderPalettes(); 
  };
  
  const closeFn = () => {
    if(els.closeSave.disabled) return;
    els.backdrop.classList.remove('open');
    save(KEYS.items, items); refreshAll();
    els.exportMenu.style.display='none'; els.resetMenu.style.display='none';
  };
  els.closeSave.onclick = closeFn;
  els.backdrop.onclick = (e) => { if(e.target===els.backdrop) closeFn(); };

  els.createRow.onclick = () => {
    const last = items[items.length-1];
    const start = last ? last.end : '08:00';
    const total = items.reduce((s,i)=>s+(Number(i.hours)||0),0);
    const rem = Math.max(0, 24-total);
    const dur = Math.min(60, rem*60) || 60;
    const end = toStr(toMins(start)+dur);
    items.push({label:'New Activity', start, end, hours:calcDur(start,end), color:null});
    renderManage(); pushHistory();
    setTimeout(()=>{ els.manageList.lastChild.scrollIntoView({behavior:'smooth'}); },50);
  };

  // Undo/Redo Keys
  document.addEventListener('keydown', (e)=>{
    if(els.backdrop.classList.contains('open')){
      if((e.ctrlKey||e.metaKey) && e.key==='z'){ e.preventDefault(); undo(); }
      if((e.ctrlKey||e.metaKey) && (e.key==='y' || (e.shiftKey && e.key==='Z'))){ e.preventDefault(); redo(); }
    }
  });

  // Menus
  const toggleMenu = (m, o) => { 
    const was = m.style.display==='block'; 
    document.querySelectorAll('.popup-menu').forEach(p=>p.style.display='none'); 
    if(!was) m.style.display='block'; 
  };
  els.exportBtn.onclick=(e)=>{ e.stopPropagation(); toggleMenu(els.exportMenu); };
  els.resetBtn.onclick=(e)=>{ e.stopPropagation(); toggleMenu(els.resetMenu); };
  document.onclick=()=>{ document.querySelectorAll('.popup-menu').forEach(p=>p.style.display='none'); };

  // Menu Actions
  els.rClear.onclick=()=>{ if(confirm('Delete all activities?')){ items=[]; renderManage(); pushHistory(); } };
  els.rFac.onclick=()=>{ if(confirm('Revert to Factory Default?')){ items=JSON.parse(JSON.stringify(FACTORY_DEFAULT)); renderManage(); pushHistory(); } };
  els.rSet.onclick=()=>{ save(KEYS.userDefault, items); announce('Saved as Default'); };
  els.rDef.onclick=()=>{ 
    const u=load(KEYS.userDefault); 
    if(u){ if(confirm('Load your saved default?')){ items=JSON.parse(JSON.stringify(u)); renderManage(); pushHistory(); } }
    else alert('No default saved yet.');
  };

  els.exCsv.onclick=()=>{
    const csv="Activity,Start,End,Hours\n"+items.map(i=>`"${i.label}",${i.start},${i.end},${i.hours}`).join('\n');
    down(new Blob([csv],{type:'text/csv'}), 'plan.csv');
  };
  els.exSvg.onclick=()=>{
    const s=new XMLSerializer().serializeToString(els.svg);
    down(new Blob([s],{type:'image/svg+xml'}), 'chart.svg');
  };
  function down(b,n){ const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=n; a.click(); }

  els.helpBtn.onclick = () => alert("Guide:\n• Plans are strictly 24 hours.\n• Toggle Legend to focus on the chart.\n• Customize to add/edit activities.\n• Use Undo (Ctrl+Z) / Redo (Ctrl+Y).\n• Circular time (e.g. 23:00 -> 06:00) is supported.");

  // Init
  if(window.innerWidth<900){ els.toggle.click(); }
  refreshAll(); pushHistory();

})();
</script>
</body>
</html>
