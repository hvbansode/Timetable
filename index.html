<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="Daily Activity Breakdown — accessible, editable, and exportable timetable with an SVG chart." />
  <title>Daily Activity Breakdown</title>

  <style>
    /* ---------- THEME VARIABLES & ACCESSIBILITY ---------- */
    :root{
      --bg: #121212;
      --surface: #1e1e1e;
      --text: #e0e0e0;
      --muted-text: #bdbdbd;
      --primary: #76c7c0;
      --danger: #ef5350;
      --card-radius: 12px;
      --container-max: 1100px;
      --gap: 16px;
      --shadow: 0 6px 20px rgba(0,0,0,0.5);
      --accent-contrast: #000;
      --chart-size: 420px;
      --swatch-size: 18px;
      --font-sans: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;

      /* default color palette for slices (19 colors) */
      --colors: #F44336,#E91E63,#9C27B0,#673AB7,#3F51B5,#2196F3,#03A9F4,#00BCD4,#009688,#4CAF50,#8BC34A,#CDDC39,#FFEB3B,#FFC107,#FF9800,#FF5722,#795548,#9E9E9E,#607D8B;
    }

    /* Light theme override */
    .theme-light {
      --bg: #f6f7f9;
      --surface: #ffffff;
      --text: #111827;
      --muted-text: #6b7280;
      --shadow: 0 6px 18px rgba(16,24,40,0.06);
      --accent-contrast: #fff;
    }

    @media (prefers-color-scheme: light){
      :root{
        /* If user prefers light by system we still default to dark unless toggled,
           but this gives consistent sensible defaults for new users. */
      }
    }

    @media (prefers-reduced-motion: reduce){
      html[reduce-motion] { --reduced-motion: 1; }
    }

    html,body{
      height:100%;
      margin:0;
      font-family: var(--font-sans);
      background-color:var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* ---------- LAYOUT ---------- */
    .skip-link{
      position:absolute;
      left:-999px;
      top:auto;
      width:1px;height:1px;overflow:hidden;
    }
    .skip-link:focus{
      left:1rem;top:1rem;width:auto;height:auto;padding:8px 12px;background:var(--primary);color:var(--accent-contrast);border-radius:6px;z-index:1000;box-shadow:var(--shadow);
    }

    .app {
      max-width: var(--container-max);
      margin: 22px auto;
      padding: 18px;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:var(--gap);
      margin-bottom:18px;
    }

    h1{
      margin:0;
      font-size:1.5rem;
      color:var(--primary);
      line-height:1.1;
    }
    .subtitle{
      color:var(--muted-text);
      font-size:0.95rem;
    }

    main {
      display:grid;
      grid-template-columns: 1fr 360px;
      gap:18px;
    }
    @media (max-width: 980px){
      main { grid-template-columns: 1fr; }
    }

    .card{
      background:var(--surface);
      border-radius:var(--card-radius);
      padding:18px;
      box-shadow:var(--shadow);
    }

    /* ---------- CHART & LEGEND ---------- */
    .chart-wrap{ display:flex;flex-direction:column; gap:12px; align-items:stretch; }
    figure{ margin:0; }
    figcaption{ margin-top:8px; color:var(--muted-text); font-size:0.95rem; }

    .chart-frame{
      display:flex;
      align-items:center;
      justify-content:center;
      min-height: calc(var(--chart-size));
    }

    svg.pie {
      width:100%;
      max-width: var(--chart-size);
      height:auto;
      max-height: var(--chart-size);
      transition: transform 350ms ease;
    }
    /* avoid animation if reduced-motion */
    html[reduce-motion] svg.pie { transition-duration: 0ms; }

    .legend { display:flex; flex-direction:column; gap:8px; max-height:55vh; overflow:auto; padding-right:6px; }
    .legend-item{ display:flex; gap:10px; align-items:center; cursor:pointer; user-select:none; padding:4px; border-radius:8px; }
    .legend-item:focus, .legend-item[aria-pressed="true"]{ outline:3px solid rgba(118,199,192,0.18); outline-offset:2px; background: rgba(118,199,192,0.03); }
    .swatch{ width:var(--swatch-size); height:var(--swatch-size); border-radius:4px; flex-shrink:0; border:2px solid rgba(0,0,0,0.12); }
    .legend-label{ font-size:0.95rem; color:var(--text); }

    /* ---------- TABLE ---------- */
    .data-wrap{ overflow:auto; margin-top:8px; }
    .data-table{ width:100%; border-collapse:collapse; margin-top:8px; }
    .data-table th, .data-table td{ padding:8px 10px; text-align:left; font-size:0.95rem; border-bottom:1px solid rgba(255,255,255,0.04); color:var(--text); }
    .data-table th{ color:var(--muted-text); font-weight:600; font-size:0.85rem; }
    .row-highlight{ background: rgba(118,199,192,0.06); }

    /* editable fields */
    .editable{ background:transparent; border:none; color:var(--text); font-size:0.95rem; padding:4px; border-radius:6px; width:100%; }
    .editable:focus{ outline:3px solid rgba(118,199,192,0.18); outline-offset:2px; background: rgba(118,199,192,0.02); }

    /* controls */
    .controls{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:8px; }
    .btn{ background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--text); padding:8px 12px; border-radius:8px; font-size:0.95rem; cursor:pointer; }
    .btn:focus{ outline:3px solid rgba(118,199,192,0.18); outline-offset:2px; }
    .btn[aria-pressed="true"]{ background:var(--primary); color:var(--accent-contrast); border-color:transparent; }

    .small{ font-size:0.85rem; padding:6px 10px; }

    footer{ margin-top:18px; text-align:center; color:var(--muted-text); font-size:0.9rem; }

    /* forced-colors accessibility */
    @media (forced-colors: active){
      :root{ --surface:Window; --bg:Window; --text:WindowText; }
    }

    /* utility */
    .sr-only{ position:absolute!important; width:1px!important; height:1px!important; padding:0!important; margin:-1px!important; overflow:hidden!important; clip:rect(0,0,0,0)!important; white-space:nowrap!important; border:0!important; }

    /* focus visible improvements */
    :focus{ scroll-margin-top: 120px; }
  </style>
</head>
<body>
  <a href="#main-content" class="skip-link">Skip to main content</a>

  <div class="app" id="app">
    <header>
      <div>
        <h1 id="page-title">Daily Activity Breakdown</h1>
        <div class="subtitle">Editable, reorderable, exportable — accessible timetable with SVG visualization.</div>
      </div>

      <div style="display:flex;gap:8px;align-items:center;">
        <label for="theme-toggle" class="sr-only">Toggle theme</label>
        <button id="theme-toggle" class="btn small" aria-pressed="false" title="Toggle light/dark theme">Light theme</button>

        <label for="motion-toggle" class="sr-only">Reduce motion</label>
        <button id="motion-toggle" class="btn small" aria-pressed="false" title="Toggle reduced motion">Motion</button>
      </div>
    </header>

    <main id="main-content" tabindex="-1" aria-labelledby="page-title">
      <!-- CHART & TABLE -->
      <section class="card chart-wrap" aria-labelledby="chart-heading">
        <div style="display:flex;align-items:center;justify-content:space-between;">
          <h2 id="chart-heading" style="margin:0;font-size:1.1rem;color:var(--text)">Daily Activity — Chart</h2>
          <div id="chart-live" class="sr-only" aria-live="polite" aria-atomic="true">Chart ready</div>
        </div>

        <figure style="display:flex;flex-direction:column;align-items:center;">
          <div class="chart-frame" role="group" aria-labelledby="chart-heading">
            <!-- Focusable SVG -->
            <svg id="pie-svg" class="pie" role="img" aria-label="Pie chart showing distribution of daily activities" viewBox="0 0 420 420" tabindex="0"></svg>
          </div>

          <figcaption>Use the table or legend to navigate. Click a legend item or table row to highlight a slice. Export options available in the side panel.</figcaption>
        </figure>

        <div class="data-wrap card" style="margin-top:12px; padding:12px;">
          <div style="display:flex;align-items:center;justify-content:space-between;">
            <strong>Data table</strong>
            <div style="color:var(--muted-text);font-size:0.9rem;">Totals update live and persist to your browser</div>
          </div>

          <div style="overflow:auto;margin-top:8px;">
            <table class="data-table" id="data-table" summary="Breakdown of activities and hours.">
              <thead>
                <tr>
                  <th scope="col">Activity</th>
                  <th scope="col">Time</th>
                  <th scope="col">Hours</th>
                  <th scope="col">Share</th>
                  <th scope="col" aria-hidden="true"></th>
                </tr>
              </thead>
              <tbody>
                <!-- Populated by JS -->
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- SIDE: legend & controls -->
      <aside class="side" aria-labelledby="side-heading">
        <div class="card" aria-hidden="false" style="display:flex;flex-direction:column;gap:12px;">
          <h3 id="side-heading" style="margin:0;font-size:1rem;color:var(--text)">Legend & Controls</h3>

          <div class="controls" role="toolbar" aria-label="Chart controls">
            <button id="download-png" class="btn small" title="Export chart as PNG">Export PNG</button>
            <button id="download-csv" class="btn small" title="Download CSV">Export CSV</button>
            <button id="reset-defaults" class="btn small" title="Reset to built-in default data">Reset</button>
          </div>

          <hr style="border:none;height:1px;margin:8px 0;background:rgba(255,255,255,0.03)" />

          <div>
            <strong style="display:block;margin-bottom:6px">Legend</strong>
            <div id="legend" class="legend" role="list" aria-label="Chart legend">
              <!-- Populated by JS -->
            </div>
          </div>

          <div style="font-size:0.9rem;color:var(--muted-text);">
            <strong>Tip:</strong>
            <p style="margin:6px 0 0 0">Edit hours directly in the table. Use the up/down arrows in the table to reorder activities. Changes auto-save to your browser.</p>
          </div>
        </div>
      </aside>
    </main>

    <footer>
      <div>Made accessible — semantic HTML, keyboard support, color themes, and exports. Data stored locally in your browser.</div>
    </footer>
  </div>

  <script>
    /* ---------- Single source of truth for activities ---------- */
    const DEFAULT_DATA = [
      { label: 'Morning Routine (5:30-6:00 AM)', hours: 0.5 },
      { label: 'Meditation (6:00-6:30 AM)', hours: 0.5 },
      { label: 'Light Exercise (6:30-7:00 AM)', hours: 0.5 },
      { label: 'Study Session 1 (7:00-8:30 AM)', hours: 1.5 },
      { label: 'Breakfast & News (8:30-9:00 AM)', hours: 0.5 },
      { label: 'Study Session 2 (9:00 AM - 12:00 PM)', hours: 3 },
      { label: 'Short Break (12:00-12:30 PM)', hours: 0.5 },
      { label: 'Mock Test (12:30-2:30 PM)', hours: 2 },
      { label: 'Lunch & Relax (2:30-3:30 PM)', hours: 1 },
      { label: 'Study Session 3 (3:30-5:30 PM)', hours: 2 },
      { label: 'Break (5:30-6:00 PM)', hours: 0.5 },
      { label: 'Study Session 4 (6:00-7:30 PM)', hours: 1.5 },
      { label: 'Dinner & Talk (7:30-8:00 PM)', hours: 0.5 },
      { label: 'Light Reading (8:00-9:30 PM)', hours: 1.5 },
      { label: 'Planning (9:30-10:00 PM)', hours: 0.5 },
      { label: 'Sleep Prep (10:00-10:30 PM)', hours: 0.5 },
      { label: 'Sleep (10:30 PM - 5:30 AM)', hours: 7 }
    ];

    const STORAGE_KEY = 'daily-activity-data-v1';
    let activities = loadActivities();

    // Helpers for theme & motion
    const appEl = document.getElementById('app');
    const htmlEl = document.documentElement;

    function loadActivities(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return JSON.parse(JSON.stringify(DEFAULT_DATA));
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed) || parsed.length === 0) return JSON.parse(JSON.stringify(DEFAULT_DATA));
        // normalize numbers
        parsed.forEach(p => { p.hours = Number(p.hours) || 0; p.label = String(p.label||''); });
        return parsed;
      } catch(e) {
        console.warn('Failed to load activities, using defaults', e);
        return JSON.parse(JSON.stringify(DEFAULT_DATA));
      }
    }

    function saveActivities(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(activities));
      announce('Changes saved locally.');
    }

    function resetToDefaults(){
      activities = JSON.parse(JSON.stringify(DEFAULT_DATA));
      saveActivities();
      renderAll();
      announce('Reset to default schedule.');
    }

    // Utility: announce to ARIA live region
    function announce(text){
      const live = document.getElementById('chart-live');
      live.textContent = text;
    }

    // ---------- Chart drawing (accessible SVG pie) ----------
    const svg = document.getElementById('pie-svg');

    function polarToCartesian(cx, cy, r, angleDeg){
      const angleRad = (angleDeg-90) * Math.PI/180.0;
      return { x: cx + (r * Math.cos(angleRad)), y: cy + (r * Math.sin(angleRad)) };
    }

    function describeArc(cx, cy, r, startAngle, endAngle){
      const start = polarToCartesian(cx, cy, r, endAngle);
      const end = polarToCartesian(cx, cy, r, startAngle);
      const largeArcFlag = endAngle - startAngle <= 180 ? '0' : '1';
      const d = [
        `M ${cx} ${cy}`,
        `L ${start.x} ${start.y}`,
        `A ${r} ${r} 0 ${largeArcFlag} 0 ${end.x} ${end.y}`,
        'Z'
      ].join(' ');
      return d;
    }

    function getColorPalette(){
      const css = getComputedStyle(document.documentElement).getPropertyValue('--colors') || '';
      return css.split(',').map(s => s.trim()).filter(Boolean);
    }

    function drawChart(selectedIndex = null){
      // clear svg
      while(svg.firstChild) svg.removeChild(svg.firstChild);

      const size = 420;
      const cx = size/2;
      const cy = size/2;
      const r = Math.min(cx,cy) - 10;

      svg.setAttribute('viewBox', `0 0 ${size} ${size}`);
      svg.setAttribute('width', '100%');
      svg.setAttribute('height', '100%');
      svg.setAttribute('role','img');

      const total = activities.reduce((s,a)=>s+a.hours,0) || 1;
      let angleStart = 0;
      const colors = getColorPalette();
      const defs = document.createElementNS('http://www.w3.org/2000/svg','defs');

      // Add title for screen readers
      const title = document.createElementNS('http://www.w3.org/2000/svg','title');
      title.textContent = 'Pie chart of daily activities';
      svg.appendChild(title);

      activities.forEach((act, i) => {
        const portion = (act.hours/total) * 360;
        const angleEnd = angleStart + portion;
        const d = describeArc(cx,cy,r, angleStart, angleEnd);
        const path = document.createElementNS('http://www.w3.org/2000/svg','path');
        path.setAttribute('d', d);
        path.setAttribute('data-index', i);
        const color = colors[i % colors.length] || '#888';
        path.setAttribute('fill', color);
        path.setAttribute('stroke', getComputedStyle(document.documentElement).getPropertyValue('--surface') || '#000');
        path.setAttribute('stroke-width', '0.5');

        // accessibility attributes
        const pct = Math.round((act.hours/total)*1000)/10;
        path.setAttribute('role','img');
        path.setAttribute('tabindex','-1');
        path.setAttribute('aria-label', `${act.label}: ${act.hours} hours, ${pct}%`);

        // mouse/keyboard interactivity
        path.addEventListener('click', () => selectSlice(i));
        path.addEventListener('mouseenter', () => highlightLegend(i));
        path.addEventListener('mouseleave', () => clearLegendHighlight(i));

        // keyboard: allow Enter/Space when focused via external control (SVG itself handles arrow navigation)
        svg.appendChild(path);

        // If selected, apply slight scale transform by cloning with transform-group
        if (i === selectedIndex) {
          path.setAttribute('transform', `scale(1.03) translate(${(cx - cx*1.03).toFixed(2)}, ${(cy - cy*1.03).toFixed(2)})`);
          path.setAttribute('stroke-width', '1.5');
        }

        // attach a small label near centroid for large slices (optional)
        if (portion > 20) {
          const midAngle = angleStart + portion/2;
          const labelPos = polarToCartesian(cx, cy, r*0.65, midAngle);
          const text = document.createElementNS('http://www.w3.org/2000/svg','text');
          text.setAttribute('x', labelPos.x);
          text.setAttribute('y', labelPos.y);
          text.setAttribute('font-size','10');
          text.setAttribute('fill', '#fff');
          text.setAttribute('text-anchor','middle');
          text.setAttribute('dominant-baseline','central');
          text.textContent = `${Math.round(pct)}%`;
          svg.appendChild(text);
        }

        angleStart = angleEnd;
      });

      // center circle for aesthetics
      const center = document.createElementNS('http://www.w3.org/2000/svg','circle');
      center.setAttribute('cx', cx);
      center.setAttribute('cy', cy);
      center.setAttribute('r', Math.max(60, r*0.35));
      center.setAttribute('fill', getComputedStyle(document.documentElement).getPropertyValue('--surface').trim() || '#222');
      center.setAttribute('pointer-events','none');
      svg.appendChild(center);

      // keyboard navigation on SVG: Arrow keys cycle slices
      svg.removeEventListener('keydown', svg._kbd); // remove if present
      svg._kbd = (e) => {
        const n = activities.length;
        if (!['ArrowLeft','ArrowUp','ArrowRight','ArrowDown','Home','End'].includes(e.key)) return;
        e.preventDefault();
        let current = selectedSliceIndex !== null ? selectedSliceIndex : 0;
        if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') current = (current - 1 + n) % n;
        if (e.key === 'ArrowRight' || e.key === 'ArrowDown') current = (current + 1) % n;
        if (e.key === 'Home') current = 0;
        if (e.key === 'End') current = n-1;
        selectSlice(current);
      };
      svg.addEventListener('keydown', svg._kbd);
      svg.setAttribute('tabindex','0'); // allow focus
    }

    // selected slice tracking
    let selectedSliceIndex = null;

    // ---------- Legend & table rendering ----------
    function populateLegend(){
      const legend = document.getElementById('legend');
      legend.innerHTML = '';
      const colors = getColorPalette();
      activities.forEach((a,i) => {
        const item = document.createElement('div');
        item.className = 'legend-item';
        item.role = 'button';
        item.tabIndex = 0;
        item.setAttribute('aria-pressed', 'false');
        item.dataset.index = i;

        const sw = document.createElement('span');
        sw.className = 'swatch';
        sw.style.backgroundColor = colors[i % colors.length] || '#888';

        const lab = document.createElement('div');
        lab.className = 'legend-label';
        lab.textContent = a.label;

        item.appendChild(sw);
        item.appendChild(lab);

        item.addEventListener('click', () => selectSlice(i));
        item.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ' || e.key === 'Spacebar') { e.preventDefault(); selectSlice(i); }
        });
        item.addEventListener('mouseenter', () => highlightSliceVisual(i));
        item.addEventListener('mouseleave', () => drawChart(selectedSliceIndex));

        legend.appendChild(item);
      });
    }

    function populateTable(){
      const tbody = document.querySelector('#data-table tbody');
      tbody.innerHTML = '';
      const total = activities.reduce((s,a)=>s+a.hours,0) || 1;
      activities.forEach((a,i) => {
        const tr = document.createElement('tr');
        tr.id = 'row-' + i;

        // Activity editable cell
        const tdLabel = document.createElement('td');
        const inputLabel = document.createElement('input');
        inputLabel.className = 'editable';
        inputLabel.value = a.label;
        inputLabel.setAttribute('aria-label', `Activity label ${i+1}`);
        inputLabel.addEventListener('change', (e) => {
          activities[i].label = e.target.value.trim() || 'Untitled';
          saveActivities();
          renderAll();
        });
        tdLabel.appendChild(inputLabel);
        tr.appendChild(tdLabel);

        // Time extraction (if parentheses exist)
        const tdTime = document.createElement('td');
        const timeText = a.label.match(/\(([^)]+)\)$/)?.[1] ?? '';
        tdTime.textContent = timeText;
        tr.appendChild(tdTime);

        // Hours editable
        const tdHours = document.createElement('td');
        const inputHours = document.createElement('input');
        inputHours.className = 'editable';
        inputHours.type = 'number';
        inputHours.step = '0.25';
        inputHours.min = '0';
        inputHours.value = a.hours;
        inputHours.setAttribute('aria-label', `Hours for ${a.label}`);
        inputHours.addEventListener('change', (e) => {
          let v = Number(e.target.value);
          if (Number.isNaN(v) || v < 0) v = 0;
          activities[i].hours = v;
          saveActivities();
          renderAll();
        });
        // Keyboard: arrow up/down increment/decrement
        inputHours.addEventListener('keydown', (e) => {
          if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
            e.preventDefault();
            const delta = e.key === 'ArrowUp' ? 0.25 : -0.25;
            let v = Math.round((Number(inputHours.value || 0) + delta) * 100)/100;
            if (v < 0) v = 0;
            inputHours.value = v;
            activities[i].hours = v;
            saveActivities();
            renderAll();
          }
        });
        tdHours.appendChild(inputHours);
        tr.appendChild(tdHours);

        // Share %
        const tdShare = document.createElement('td');
        const pct = Math.round((a.hours/total)*1000)/10;
        tdShare.textContent = pct + '%';
        tr.appendChild(tdShare);

        // Reorder buttons (Up/Down)
        const tdCtrl = document.createElement('td');
        tdCtrl.style.whiteSpace = 'nowrap';
        const upBtn = document.createElement('button');
        upBtn.className = 'btn small';
        upBtn.textContent = '↑';
        upBtn.title = 'Move up';
        upBtn.addEventListener('click', () => moveItem(i, -1));
        const downBtn = document.createElement('button');
        downBtn.className = 'btn small';
        downBtn.textContent = '↓';
        downBtn.title = 'Move down';
        downBtn.addEventListener('click', () => moveItem(i, +1));

        const delBtn = document.createElement('button');
        delBtn.className = 'btn small';
        delBtn.style.marginLeft = '8px';
        delBtn.textContent = 'Delete';
        delBtn.title = 'Remove activity';
        delBtn.addEventListener('click', () => {
          if (confirm('Remove this activity?')) { activities.splice(i,1); saveActivities(); renderAll(); }
        });

        tdCtrl.appendChild(upBtn);
        tdCtrl.appendChild(downBtn);
        tdCtrl.appendChild(delBtn);
        tr.appendChild(tdCtrl);

        // row click -> select slice
        tr.addEventListener('click', () => selectSlice(i));
        tbody.appendChild(tr);
      });
    }

    // move item by delta (-1 or +1)
    function moveItem(index, delta){
      const newIndex = index + delta;
      if (newIndex < 0 || newIndex >= activities.length) return;
      const [item] = activities.splice(index, 1);
      activities.splice(newIndex, 0, item);
      saveActivities();
      renderAll();
      // focus moved row
      setTimeout(()=> document.getElementById('row-' + newIndex)?.querySelector('.editable')?.focus(), 50);
    }

    // ---------- Selection & highlighting ----------
    function selectSlice(index){
      selectedSliceIndex = index;
      highlightLegend(index);
      highlightTableRow(index);
      drawChart(index);
      announce(`${activities[index].label}, ${activities[index].hours} hours selected.`);
    }

    function highlightLegend(index){
      const legendItems = document.querySelectorAll('#legend .legend-item');
      legendItems.forEach(li => {
        li.setAttribute('aria-pressed', String(li.dataset.index == index));
        if (Number(li.dataset.index) === Number(index)) li.classList.add('active');
        else li.classList.remove('active');
      });
    }

    function clearLegendHighlight(){
      const legendItems = document.querySelectorAll('#legend .legend-item');
      legendItems.forEach(li => li.setAttribute('aria-pressed','false'));
    }

    function highlightSliceVisual(index){
      // draw with that slice selected
      drawChart(index);
    }

    function highlightTableRow(index){
      document.querySelectorAll('#data-table tbody tr').forEach((tr, i) => {
        if (i === index) tr.classList.add('row-highlight');
        else tr.classList.remove('row-highlight');
      });
      // ensure the selected row is visible
      const row = document.getElementById('row-' + index);
      if (row) row.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // ---------- Export functions ----------
    function downloadCSV(){
      const header = ['Activity','Time','Hours'];
      const rows = activities.map(a => {
        const time = a.label.match(/\(([^)]+)\)$/)?.[1] ?? '';
        return [a.label.replace(/\(([^)]*)\)$/,'').trim(), time, a.hours];
      });
      const csv = [header, ...rows].map(r=> r.map(field => `"${String(field).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'daily-activity-breakdown.csv';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      announce('CSV exported.');
    }

    function downloadPNG(){
      // render SVG to canvas and trigger PNG download
      const svgEl = document.getElementById('pie-svg');
      const serializer = new XMLSerializer();
      const svgString = serializer.serializeToString(svgEl);
      const blob = new Blob([svgString], {type: 'image/svg+xml;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const img = new Image();
      img.onload = function(){
        const canvas = document.createElement('canvas');
        const scale = 2; // higher quality
        canvas.width = svgEl.viewBox.baseVal.width * scale;
        canvas.height = svgEl.viewBox.baseVal.height * scale;
        const ctx = canvas.getContext('2d');
        // optional: fill background to match theme
        ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--surface').trim() || '#fff';
        ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        canvas.toBlob((blob) => {
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = 'daily-activity-chart.png';
          document.body.appendChild(link);
          link.click();
          link.remove();
          URL.revokeObjectURL(link.href);
          URL.revokeObjectURL(url);
          announce('PNG exported.');
        }, 'image/png');
      };
      img.onerror = function(){
        URL.revokeObjectURL(url);
        announce('Export failed.');
        alert('Export failed — your browser may block SVG to Canvas conversion for local files. Try serving the file over HTTP.');
      };
      img.src = url;
    }

    // ---------- UI wiring ----------
    function renderAll(){
      populateLegend();
      populateTable();
      drawChart(selectedSliceIndex);
    }

    // Setup event handlers
    document.getElementById('download-csv').addEventListener('click', downloadCSV);
    document.getElementById('download-png').addEventListener('click', downloadPNG);
    document.getElementById('reset-defaults').addEventListener('click', () => {
      if (confirm('Reset schedule to the built-in defaults? This will overwrite your local changes.')) resetToDefaults();
    });

    // Theme toggle
    const themeToggle = document.getElementById('theme-toggle');
    themeToggle.addEventListener('click', () => {
      const light = appEl.classList.toggle('theme-light');
      themeToggle.setAttribute('aria-pressed', String(light));
      themeToggle.textContent = light ? 'Dark theme' : 'Light theme';
      announce(light ? 'Light theme enabled.' : 'Dark theme enabled.');
      // Save preference
      try { localStorage.setItem('daily-activity-theme', light ? 'light' : 'dark'); } catch(e){}
    });

    // Motion toggle
    const motionToggle = document.getElementById('motion-toggle');
    motionToggle.addEventListener('click', () => {
      const reduced = htmlEl.hasAttribute('reduce-motion');
      if (reduced) {
        htmlEl.removeAttribute('reduce-motion');
        motionToggle.setAttribute('aria-pressed','false');
        motionToggle.textContent = 'Motion';
        announce('Motion enabled.');
        try { localStorage.removeItem('daily-activity-motion'); } catch(e){}
      } else {
        htmlEl.setAttribute('reduce-motion','');
        motionToggle.setAttribute('aria-pressed','true');
        motionToggle.textContent = 'Reduced motion';
        announce('Reduced motion enabled.');
        try { localStorage.setItem('daily-activity-motion','reduce'); } catch(e){}
      }
    });

    // load theme & motion from localStorage
    (function initPreferences(){
      try {
        const theme = localStorage.getItem('daily-activity-theme');
        if (theme === 'light') {
          appEl.classList.add('theme-light');
          themeToggle.setAttribute('aria-pressed','true');
          themeToggle.textContent = 'Dark theme';
        } else {
          themeToggle.setAttribute('aria-pressed','false');
          themeToggle.textContent = 'Light theme';
        }
        const motion = localStorage.getItem('daily-activity-motion');
        if (motion === 'reduce'){
          htmlEl.setAttribute('reduce-motion','');
          motionToggle.setAttribute('aria-pressed','true');
          motionToggle.textContent = 'Reduced motion';
        } else {
          motionToggle.setAttribute('aria-pressed','false');
          motionToggle.textContent = 'Motion';
        }
      } catch(e){}
    })();

    // Keyboard: focus styling and accessible hints
    document.addEventListener('keydown', (e) => {
      // Press "?" to show quick help (optional)
      if (e.key === '?') {
        alert('Keyboard tips:\n- Focus the chart (tab) then use Arrow keys to move between slices.\n- In the table, edit Hours and press ArrowUp/Down to step values.\n- Use the legend or table rows to select slices.');
      }
    });

    // initial render
    renderAll();
    announce('Chart initialized.');

    // expose some helpers for debugging (optional)
    window.__dailyActivity = {
      get: () => activities,
      set: (newData) => { activities = newData; saveActivities(); renderAll(); },
      reset: resetToDefaults
    };

  </script>
</body>
</html>
