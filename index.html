<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<meta name="description" content="Daily Activity Breakdown — minimal, accessible, and editable timetable with a refined donut chart and detail panel."/>
<title>Daily Activity — Refined</title>

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

<style>
  /* ---------------- Theme / tokens ---------------- */
  :root{
    --bg: #0b0f13;
    --surface: #0f1720;
    --muted: #9ca3af;
    --text: #e6eef6;
    --primary: #1E88E5;     /* action */
    --accent: #00BFA5;
    --elev-1: 0 10px 28px rgba(0,0,0,0.6);
    --radius: 12px;
    --container: 1150px;
    --gap: 20px;
    --chart-size: 420px;
    /* color-blind-friendly palette (Okabe-Ito inspired with additions) */
    --palette: #E69F00,#56B4E9,#009E73,#F0E442,#0072B2,#D55E00,#CC79A7,#999999,#3F51B5,#2196F3,#00BCD4,#009688,#4CAF50,#FF9800,#FF5722;
    --muted-surface: rgba(255,255,255,0.04);
  }

  @media (prefers-color-scheme: light){
    :root{
      --bg: #FAFBFC;
      --surface: #FFFFFF;
      --muted: #6B7280;
      --text: #0F172A;
      --muted-surface: rgba(0,0,0,0.04);
    }
  }

  @media (prefers-reduced-motion: reduce){
    :root { --reduced-motion: 1; }
  }

  html,body{ height:100%; margin:0; font-family: Roboto, system-ui, -apple-system, "Segoe UI", Arial; background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }

  /* ---------------- App layout ---------------- */
  .app{ max-width: var(--container); margin: 26px auto; padding: 22px; padding-bottom:140px; }

  header.appbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:18px; }
  .brand{ display:flex; align-items:center; gap:14px; }
  .logo{ width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--primary),var(--accent)); display:inline-flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:18px; box-shadow:var(--elev-1); }
  h1{ margin:0; font-size:1.15rem; font-weight:600; letter-spacing:-0.01em; }
  .subtitle{ margin-top:2px; color:var(--muted); font-size:0.92rem; }

  main.layout{ display:grid; grid-template-columns: 1fr 340px; gap:24px; align-items:start; }
  @media (max-width:1100px){ main.layout{ grid-template-columns: 1fr 320px; } }
  @media (max-width:900px){ main.layout{ grid-template-columns: 1fr; } }

  .card{ background:var(--surface); border-radius:var(--radius); padding:20px; box-shadow:var(--elev-1); }

  /* ---------------- Chart area ---------------- */
  .chart-area{ display:flex; flex-direction:column; align-items:center; gap:14px; padding:12px; }
  .donut{ width: min(100%, var(--chart-size)); max-width: var(--chart-size); aspect-ratio: 1/1; display:block; }
  .center-label{ position:relative; margin-top: -calc(var(--chart-size) * 0.58); display:flex; align-items:center; justify-content:center; pointer-events:none; }
  .center-box{ background:transparent; color:var(--text); text-align:center; pointer-events:none; width:200px; }
  .center-box .total{ font-size:1.35rem; font-weight:700; }
  .center-box .muted{ color:var(--muted); font-size:0.95rem; margin-top:6px; }

  p.hint { color:var(--muted); font-size:0.95rem; margin:0; }

  /* ---------------- Side legend ---------------- */
  .side{ display:flex; flex-direction:column; gap:12px; }
  .legend{ display:flex; flex-direction:column; gap:10px; max-height:56vh; overflow:auto; padding:6px; }
  .legend::-webkit-scrollbar{ width:10px; }
  .legend::-webkit-scrollbar-thumb{ background:linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03)); border-radius:10px; border:2px solid transparent; background-clip:padding-box; }
  .legend-item{ display:flex; gap:12px; align-items:center; padding:10px; border-radius:10px; cursor:pointer; transition: transform .16s ease, box-shadow .16s ease; }
  @media (prefers-reduced-motion: reduce){ .legend-item{ transition:none; } }
  .legend-item:hover{ transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.5); }
  .legend-item:focus{ outline:3px solid rgba(30,136,229,0.14); outline-offset:2px; }
  .swatch{ width:16px; height:16px; border-radius:4px; flex-shrink:0; box-shadow: 0 2px 8px rgba(0,0,0,0.3) inset; }

  .legend-label{ font-weight:600; font-size:0.95rem; color:var(--text); }
  .legend-sub{ color:var(--muted); font-size:0.9rem; margin-top:5px; }

  /* ---------------- FAB + sheet ---------------- */
  .fab{ position: fixed; right: 22px; bottom: 22px; background:var(--primary); color:#fff; width:56px;height:56px;border-radius:14px; display:flex;align-items:center;justify-content:center; box-shadow: 0 12px 34px rgba(0,0,0,0.6); cursor:pointer; border:none; font-size:20px; }
  .fab:focus{ outline:3px solid rgba(30,136,229,0.18); outline-offset:4px; }

  .sheet{ position: fixed; right: 22px; bottom: 92px; width: 380px; max-width: calc(100% - 48px); border-radius:12px; background:var(--surface); box-shadow:var(--elev-1); padding:12px; transform: translateY(8px); transition: opacity .22s ease, transform .22s ease; opacity:0; pointer-events:none; z-index:1300; }
  .sheet.open{ opacity:1; pointer-events:auto; transform: translateY(0); }

  .controls-row{ display:flex; gap:8px; align-items:center; margin-bottom:8px; }
  .btn{ border:0; background:transparent; color:var(--text); padding:8px 10px; border-radius:8px; cursor:pointer; font-weight:600; }
  .btn.ghost{ border:1px solid var(--muted-surface); background:transparent; }
  .btn.primary{ background:var(--primary); color:#fff; }
  .btn:focus{ outline:3px solid rgba(30,136,229,0.12); outline-offset:2px; }

  /* table in sheet */
  table.min-table{ width:100%; border-collapse:collapse; font-size:0.95rem; }
  table.min-table th, table.min-table td{ padding:8px 6px; text-align:left; color:var(--text); border-bottom:1px solid rgba(255,255,255,0.03); }
  input.small{ width:86px; padding:6px 8px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:var(--text); }

  /* ---------------- Detail panel (bottom) ---------------- */
  .detail-panel{ position: fixed; left: 50%; transform: translateX(-50%); bottom: 12px; width: min(1000px, calc(100% - 32px)); background: linear-gradient(180deg, rgba(15,23,32,0.96), rgba(15,23,32,0.98)); color: var(--text); border-radius: 14px; box-shadow: 0 12px 36px rgba(0,0,0,0.6); padding: 12px 16px; display:flex; gap:12px; align-items:center; justify-content:space-between; pointer-events:auto; z-index:1250; transition: opacity .18s ease, transform .18s ease; }
  .detail-panel.hidden{ opacity:0; transform: translateX(-50%) translateY(8px); pointer-events:none; }
  .detail-left{ display:flex; gap:12px; align-items:center; min-width:0; }
  .detail-swatch{ width:36px; height:36px; border-radius:8px; flex-shrink:0; box-shadow: 0 6px 16px rgba(0,0,0,0.6) inset; }
  .detail-meta .title{ font-weight:700; font-size:1rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .detail-meta .sub{ color:var(--muted); font-size:0.95rem; margin-top:4px; }
  .detail-right .hours{ font-weight:700; font-size:1.12rem; }
  .detail-right .pct{ color:var(--muted); font-size:0.92rem; margin-top:4px; }

  .pin-btn{ background:transparent; border:1px solid var(--muted-surface); color:var(--muted); padding:6px 8px; border-radius:8px; cursor:pointer; }
  .pin-btn.pinned{ background:var(--primary); color:#fff; border-color:transparent; }

  /* ---------------- small helpers ---------------- */
  .sr-only{ position:absolute!important; width:1px!important; height:1px!important; padding:0!important; margin:-1px!important; overflow:hidden!important; clip:rect(0,0,0,0)!important; white-space:nowrap!important; border:0!important; }
  footer{ margin-top:18px; text-align:center; color:var(--muted); font-size:0.9rem; }

  /* print */
  @media print {
    body{ background:#fff; color:#000; }
    .app *{ box-shadow:none !important; }
    .sheet,.fab,.detail-panel,.legend{ display:none !important; }
    svg.donut{ width:450px !important; height:auto !important; }
  }
</style>
</head>
<body>
  <div class="app" id="app">
    <header class="appbar" role="banner">
      <div class="brand" aria-hidden="false">
        <div class="logo" aria-hidden="true">DA</div>
        <div>
          <h1>Daily Activity</h1>
          <div class="subtitle">Clean timetable & visualizer — refined & accessible</div>
        </div>
      </div>

      <div>
        <button id="open-sheet" class="btn ghost" aria-expanded="false" aria-controls="sheet">Table & Export</button>
      </div>
    </header>

    <main class="layout" id="main">
      <section class="card chart-area" aria-labelledby="chart-heading" role="main">
        <h2 id="chart-heading" style="margin:0;font-weight:600;font-size:1.02rem">Your day — donut overview</h2>

        <div style="position:relative;display:flex;align-items:center;justify-content:center;">
          <svg id="svgDonut" class="donut" viewBox="0 0 420 420" role="img" aria-labelledby="chart-heading" tabindex="0"></svg>
          <div class="center-label" aria-hidden="true">
            <div class="center-box" id="centerBox">
              <div class="total" id="totalHours">0 hrs</div>
              <div class="muted" id="totalLabel">Total scheduled</div>
            </div>
          </div>
        </div>

        <p class="hint">Hover a slice or legend item to view details below. Click or press Enter to select.</p>
      </section>

      <aside class="side">
        <div class="card" aria-labelledby="legend-heading">
          <h3 id="legend-heading" style="margin:0 0 8px 0;font-size:1rem;">Legend</h3>
          <div id="legend" class="legend" role="list" aria-label="Activities legend"></div>

          <div style="margin-top:12px; display:flex; gap:8px; align-items:center;">
            <button id="exportPNG" class="btn">Export PNG</button>
            <button id="exportCSV" class="btn">Export CSV</button>
          </div>
        </div>

        <div class="card" style="padding:12px;">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div>
              <div style="font-weight:700">Quick info</div>
              <div class="muted">Tip: edits save locally (localStorage).</div>
            </div>
            <div style="font-size:0.85rem;color:var(--muted)">Auto-save</div>
          </div>
        </div>
      </aside>
    </main>

    <footer>Minimal • accessible • local-only</footer>
  </div>

  <!-- actions -->
  <button id="fab" class="fab" aria-label="Open table and settings">⚙️</button>

  <aside id="sheet" class="sheet" role="dialog" aria-modal="false" aria-labelledby="sheetTitle" hidden>
    <h4 id="sheetTitle">Table & exports</h4>

    <div class="controls-row" role="toolbar" aria-label="Sheet controls">
      <button id="addRow" class="btn">Add</button>
      <button id="reset" class="btn">Reset</button>
      <button id="clearLocalBtn" class="btn ghost">Clear Saved</button>
      <div style="flex:1"></div>
      <button id="closeSheet" class="btn">Close</button>
    </div>

    <div style="max-height:50vh; overflow:auto;">
      <table class="min-table" id="editTable" aria-describedby="sheetTitle">
        <thead><tr><th>Activity</th><th style="width:96px">Hours</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div style="display:flex;gap:8px;margin-top:10px;justify-content:flex-end;">
      <button id="sheetExportPNG" class="btn ghost">Export PNG</button>
      <button id="sheetExportCSV" class="btn ghost">Export CSV</button>
    </div>
  </aside>

  <!-- bottom detail panel -->
  <div id="detailPanel" class="detail-panel hidden" role="region" aria-live="polite" aria-atomic="true" aria-label="Activity details">
    <div class="detail-left">
      <div id="detailSwatch" class="detail-swatch" style="background:#ddd"></div>
      <div class="detail-meta">
        <div id="detailTitle" class="title">Hover a slice</div>
        <div id="detailSub" class="sub">Move your mouse over the chart or legend to see activity details here.</div>
      </div>
    </div>

    <div style="display:flex;gap:10px;align-items:center;">
      <div class="detail-right">
        <div id="detailHours" class="hours">—</div>
        <div id="detailPct" class="pct">—</div>
      </div>

      <div style="display:flex;flex-direction:column;gap:8px;">
        <button id="pinDetail" class="pin-btn" title="Pin detail panel">Pin</button>
      </div>
    </div>
  </div>

<script>
/* ---------- Data & persistence (robust + defaults) ---------- */
const DEFAULT = [
  { label: 'Morning Routine (5:30-6:00 AM)', hours: 0.5 },
  { label: 'Meditation (6:00-6:30 AM)', hours: 0.5 },
  { label: 'Light Exercise (6:30-7:00 AM)', hours: 0.5 },
  { label: 'Study Session 1 (7:00-8:30 AM)', hours: 1.5 },
  { label: 'Breakfast & News (8:30-9:00 AM)', hours: 0.5 },
  { label: 'Study Session 2 (9:00 AM - 12:00 PM)', hours: 3 },
  { label: 'Short Break (12:00-12:30 PM)', hours: 0.5 },
  { label: 'Mock Test (12:30-2:30 PM)', hours: 2 },
  { label: 'Lunch & Relax (2:30-3:30 PM)', hours: 1 },
  { label: 'Study Session 3 (3:30-5:30 PM)', hours: 2 },
  { label: 'Break (5:30-6:00 PM)', hours: 0.5 },
  { label: 'Study Session 4 (6:00-7:30 PM)', hours: 1.5 },
  { label: 'Dinner & Talk (7:30-8:00 PM)', hours: 0.5 },
  { label: 'Light Reading (8:00-9:30 PM)', hours: 1.5 },
  { label: 'Planning (9:30-10:00 PM)', hours: 0.5 },
  { label: 'Sleep Prep (10:00-10:30 PM)', hours: 0.5 },
  { label: 'Sleep (10:30 PM - 5:30 AM)', hours: 7 }
];

const KEY = 'da-minimal-v1';

/* robust loader */
function load(){
  try{
    const raw = localStorage.getItem(KEY);
    if (!raw) return structuredClone(DEFAULT);
    const parsed = JSON.parse(raw);
    if (!Array.isArray(parsed) || parsed.length === 0) return structuredClone(DEFAULT);
    parsed.forEach(p => { p.hours = Number(p.hours) || 0; p.label = String(p.label||''); });
    const total = parsed.reduce((s,a) => s + (Number(a.hours)||0), 0);
    if (!total) {
      console.warn('Loaded dataset totals to 0 — restoring default dataset for visibility.');
      return structuredClone(DEFAULT);
    }
    return parsed;
  } catch(e) {
    console.warn('Failed to load activities — using defaults', e);
    return structuredClone(DEFAULT);
  }
}

let data = load();
function save(){ try{ localStorage.setItem(KEY, JSON.stringify(data)); announce('Saved locally'); }catch(e){ console.warn('save failed', e); } }

/* ---------- DOM references ---------- */
const svg = document.getElementById('svgDonut');
const legendEl = document.getElementById('legend');
const totalHoursEl = document.getElementById('totalHours');

const sheet = document.getElementById('sheet');
const sheetBody = document.querySelector('#editTable tbody');
const openSheetBtn = document.getElementById('open-sheet');
const fab = document.getElementById('fab');
const clearLocalBtn = document.getElementById('clearLocalBtn');

const detailPanel = document.getElementById('detailPanel');
const detailSwatch = document.getElementById('detailSwatch');
const detailTitle = document.getElementById('detailTitle');
const detailSub = document.getElementById('detailSub');
const detailHours = document.getElementById('detailHours');
const detailPct = document.getElementById('detailPct');
const pinDetailBtn = document.getElementById('pinDetail');

let selected = null;
let hoverIndex = null;
let detailPinned = false;

/* ---------- color helpers ---------- */
function palette(){
  const css = getComputedStyle(document.documentElement).getPropertyValue('--palette') || '';
  return css.split(',').map(s => s.trim()).filter(Boolean);
}
const colors = palette();
function colorFor(i){ return colors[i % colors.length] || '#888'; }

/* ---------- arc math ---------- */
function deg2rad(d){ return d * Math.PI / 180; }
function polar(cx, cy, r, a){ return { x: cx + r * Math.cos(deg2rad(a-90)), y: cy + r * Math.sin(deg2rad(a-90)) }; }
function arcPath(cx, cy, r, start, end){
  const p1 = polar(cx,cy,r,start);
  const p2 = polar(cx,cy,r,end);
  const large = (end - start) <= 180 ? 0 : 1;
  return `M ${cx} ${cy} L ${p1.x} ${p1.y} A ${r} ${r} 0 ${large} 0 ${p2.x} ${p2.y} Z`;
}

/* ---------- animated number (respects reduced motion) ---------- */
let lastTotal = null;
function animateNumber(el, from, to, ms = 600){
  if (window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches) { el.textContent = `${to} hrs`; return; }
  const start = performance.now();
  function tick(now){
    const t = Math.min(1, (now - start) / ms);
    const v = Math.round((from + (to - from) * t) * 10) / 10;
    el.textContent = `${v} hrs`;
    if (t < 1) requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);
}

/* ---------- render logic ---------- */
function render(){
  renderLegend();
  renderSvg();
  renderCenter();
  renderTable();
  save();
}

function renderCenter(){
  const total = Math.round((data.reduce((s,d)=>s + (Number(d.hours)||0), 0) || 0) * 10) / 10;
  if (lastTotal === null) { totalHoursEl.textContent = `${total} hrs`; lastTotal = total; return; }
  if (total !== lastTotal) {
    animateNumber(totalHoursEl, lastTotal, total);
    lastTotal = total;
  }
}

/* Improved renderSvg (small hole, skip-zero, defensive) */
function renderSvg(){
  while (svg.firstChild) svg.removeChild(svg.firstChild);
  const size = 420;
  svg.setAttribute('viewBox', `0 0 ${size} ${size}`);
  svg.setAttribute('role','img');

  const cx = size/2, cy = size/2, r = Math.min(cx,cy) - 14; // slightly bigger outer radius
  const innerR = r * 0.42; // slightly smaller hole for better visual mass

  const total = Math.max(1, data.reduce((s,d)=>s + (Number(d.hours)||0), 0));
  let angle = 0;
  const allZero = data.every(d => !(Number(d.hours) > 0));

  if (allZero) {
    const ring = document.createElementNS('http://www.w3.org/2000/svg','circle');
    ring.setAttribute('cx', cx); ring.setAttribute('cy', cy); ring.setAttribute('r', r - 8);
    ring.setAttribute('fill', 'none'); ring.setAttribute('stroke', 'rgba(255,255,255,0.04)'); ring.setAttribute('stroke-width', '10');
    svg.appendChild(ring);
    return;
  }

  data.forEach((d,i) => {
    const sweep = (Number(d.hours) || 0) / total * 360;
    const start = angle;
    const end = angle + sweep;
    if (sweep > 0.0001) {
      const path = document.createElementNS('http://www.w3.org/2000/svg','path');
      path.setAttribute('d', arcPath(cx,cy,r, start, end));
      path.setAttribute('fill', colorFor(i));
      path.setAttribute('data-index', i);
      path.setAttribute('aria-label', `${d.label}, ${d.hours} hours`);
      if (selected === i) {
        const scale = 1.03;
        const tx = cx - cx*scale;
        const ty = cy - cy*scale;
        path.setAttribute('transform', `scale(${scale}) translate(${tx}, ${ty})`);
        path.setAttribute('stroke', 'rgba(0,0,0,0.28)');
        path.setAttribute('stroke-width', '1.2');
      }
      path.style.transition = window.matchMedia('(prefers-reduced-motion: reduce)').matches ? 'none' : 'transform .25s ease';
      path.addEventListener('click', ()=> select(i));
      path.addEventListener('mouseenter', ()=> showDetail(i));
      path.addEventListener('mouseleave', ()=> clearHover());
      svg.appendChild(path);
    }
    angle += sweep;
  });

  const inner = document.createElementNS('http://www.w3.org/2000/svg','circle');
  inner.setAttribute('cx', cx); inner.setAttribute('cy', cy); inner.setAttribute('r', innerR);
  inner.setAttribute('fill', getComputedStyle(document.documentElement).getPropertyValue('--surface').trim() || '#fff');
  svg.appendChild(inner);

  svg.onkeydown = (e) => {
    if (!['ArrowLeft','ArrowRight','ArrowUp','ArrowDown','Home','End'].includes(e.key)) return;
    e.preventDefault();
    const n = data.length;
    let idx = (selected === null) ? 0 : selected;
    if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') idx = (idx - 1 + n) % n;
    if (e.key === 'ArrowRight' || e.key === 'ArrowDown') idx = (idx + 1) % n;
    if (e.key === 'Home') idx = 0;
    if (e.key === 'End') idx = n - 1;
    select(idx);
  };
  svg.tabIndex = 0;
}

/* ---------- legend & table ---------- */
function renderLegend(){
  legendEl.innerHTML = '';
  data.forEach((d,i) => {
    const item = document.createElement('div');
    item.className = 'legend-item';
    item.role = 'button';
    item.tabIndex = 0;
    item.dataset.index = i;
    item.setAttribute('aria-pressed', String(selected===i));
    const sw = document.createElement('span'); sw.className='swatch'; sw.style.backgroundColor = colorFor(i);
    const txt = document.createElement('div'); txt.style.flex='1';
    txt.innerHTML = `<div class="legend-label">${escapeHtml(d.label.replace(/\s*\(.*\)$/,''))}</div><div class="legend-sub">${d.hours} hrs</div>`;
    item.appendChild(sw); item.appendChild(txt);
    item.addEventListener('click', ()=> select(i));
    item.addEventListener('keydown', (e)=> { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); select(i); }});
    item.addEventListener('mouseenter', ()=> showDetail(i));
    item.addEventListener('mouseleave', ()=> clearHover());
    legendEl.appendChild(item);
  });
}

function renderTable(){
  sheetBody.innerHTML = '';
  data.forEach((d,i) => {
    const tr = document.createElement('tr');
    const tdLabel = document.createElement('td');
    const inLabel = document.createElement('input');
    inLabel.value = d.label;
    inLabel.className = 'small';
    inLabel.addEventListener('change', (e)=>{ data[i].label = e.target.value || 'Untitled'; save(); render(); });
    tdLabel.appendChild(inLabel); tr.appendChild(tdLabel);

    const tdHours = document.createElement('td');
    const inH = document.createElement('input');
    inH.type = 'number'; inH.step = '0.25'; inH.min = '0'; inH.value = d.hours; inH.className='small';
    inH.addEventListener('change', (e)=>{ let v = Number(e.target.value); if(Number.isNaN(v)||v<0) v=0; data[i].hours = v; save(); render(); });
    tdHours.appendChild(inH); tr.appendChild(tdHours);

    const tdAct = document.createElement('td'); tdAct.style.textAlign = 'right';
    const up = document.createElement('button'); up.className='btn'; up.textContent='↑'; up.title='Move up'; up.addEventListener('click', ()=> move(i,-1));
    const down = document.createElement('button'); down.className='btn'; down.textContent='↓'; down.title='Move down'; down.addEventListener('click', ()=> move(i,1));
    const del = document.createElement('button'); del.className='btn'; del.textContent='Delete'; del.addEventListener('click', ()=> { if(confirm('Remove this activity?')){ data.splice(i,1); save(); render(); }});
    tdAct.appendChild(up); tdAct.appendChild(down); tdAct.appendChild(del); tr.appendChild(tdAct);

    tr.addEventListener('mouseenter', ()=> showDetail(i));
    tr.addEventListener('mouseleave', ()=> clearHover());
    tr.addEventListener('click', ()=> select(i));
    sheetBody.appendChild(tr);
  });
}

/* move item */
function move(index, delta){
  const to = index + delta;
  if (to < 0 || to >= data.length) return;
  const [it] = data.splice(index,1);
  data.splice(to,0,it);
  save(); render();
}

/* add / reset */
document.getElementById('addRow').addEventListener('click', ()=> { data.push({ label: 'New Activity', hours: 0.5 }); save(); render(); });
document.getElementById('reset').addEventListener('click', ()=> { if(confirm('Reset to defaults? This replaces your local changes.')){ data = structuredClone(DEFAULT); save(); render(); }});

/* clear saved storage (useful for recovery) */
clearLocalBtn.addEventListener('click', ()=> {
  if (!confirm('Clear saved data (localStorage) and reload defaults?')) return;
  localStorage.removeItem(KEY);
  data = structuredClone(DEFAULT);
  save();
  render();
  announce('Saved data cleared. Defaults restored.');
});

/* ---------- sheet open/close with focus management ---------- */
let lastActive = null;
function openSheet(){ lastActive = document.activeElement; sheet.hidden = false; sheet.classList.add('open'); openSheetBtn.setAttribute('aria-expanded','true'); // focus first input or close
  setTimeout(()=> {
    const first = sheet.querySelector('input, button');
    if (first) first.focus();
  }, 40);
}
function closeSheet(){ sheet.classList.remove('open'); sheet.hidden = true; openSheetBtn.setAttribute('aria-expanded','false'); try{ lastActive?.focus(); } catch(e){} }
openSheetBtn.addEventListener('click', ()=> sheet.hidden ? openSheet() : closeSheet());
fab.addEventListener('click', ()=> sheet.hidden ? openSheet() : closeSheet());
document.getElementById('closeSheet').addEventListener('click', closeSheet);

/* ---------- detail panel logic ---------- */
function showDetail(i){
  hoverIndex = i;
  const act = data[i];
  const total = data.reduce((s,d)=>s + (Number(d.hours) || 0),0) || 1;
  const pct = Math.round((act.hours/total)*1000)/10;
  detailSwatch.style.backgroundColor = colorFor(i);
  detailTitle.textContent = act.label.replace(/\s*\(.*\)$/,'');
  detailSub.textContent = (act.label.match(/\(([^)]+)\)$/)?.[1] ?? '');
  detailHours.textContent = `${act.hours} hrs`;
  detailPct.textContent = `${pct}%`;
  detailPanel.classList.remove('hidden');
  announce(`${act.label}, ${act.hours} hours, ${pct}%`);
}

function clearHover(){
  hoverIndex = null;
  if (detailPinned) return; // if pinned, keep showing selected or pinned content
  if (selected !== null) showSelectedDetail();
  else hideDetail();
}

function showSelectedDetail(){
  if (selected === null) return hideDetail();
  const act = data[selected];
  const total = data.reduce((s,d)=>s + (Number(d.hours) || 0),0) || 1;
  const pct = Math.round((act.hours/total)*1000)/10;
  detailSwatch.style.backgroundColor = colorFor(selected);
  detailTitle.textContent = act.label.replace(/\s*\(.*\)$/,'');
  detailSub.textContent = (act.label.match(/\(([^)]+)\)$/)?.[1] ?? '');
  detailHours.textContent = `${act.hours} hrs`;
  detailPct.textContent = `${pct}%`;
  detailPanel.classList.remove('hidden');
  announce(`${act.label} selected, ${act.hours} hours, ${pct}%`);
}

function hideDetail(){
  if (detailPinned) return;
  detailPanel.classList.add('hidden');
}

/* pin toggle */
pinDetailBtn.addEventListener('click', () => {
  detailPinned = !detailPinned;
  pinDetailBtn.classList.toggle('pinned', detailPinned);
  pinDetailBtn.textContent = detailPinned ? 'Pinned' : 'Pin';
  announce(detailPinned ? 'Detail panel pinned.' : 'Detail panel unpinned.');
});

/* ---------- selection ---------- */
function select(i){
  selected = i;
  render();
  showSelectedDetail();
}

/* ---------- export helpers ---------- */
function exportCSV(){
  const header = ['Activity','Time','Hours'];
  const rows = data.map(d => { const time = d.label.match(/\(([^)]+)\)$/)?.[1] ?? ''; return [d.label.replace(/\(([^)]*)\)$/,'').trim(), time, d.hours]; });
  const csv = [header, ...rows].map(r=> r.map(c=> `"${String(c).replaceAll('"','""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'daily-activity.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  announce('CSV exported');
}
function exportPNG(){
  const s = document.getElementById('svgDonut');
  const serializer = new XMLSerializer();
  const svgStr = serializer.serializeToString(s);
  const blob = new Blob([svgStr], { type: 'image/svg+xml;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const img = new Image();
  img.onload = ()=>{
    const scale = 2;
    const canvas = document.createElement('canvas');
    const vb = s.viewBox.baseVal;
    canvas.width = vb.width * scale;
    canvas.height = vb.height * scale;
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--surface').trim() || '#fff';
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    canvas.toBlob(blob => { const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = 'daily-activity.png'; document.body.appendChild(link); link.click(); link.remove(); URL.revokeObjectURL(url); announce('PNG exported'); }, 'image/png');
  };
  img.onerror = ()=> { URL.revokeObjectURL(url); alert('Export failed — try serving the file over HTTP.'); announce('Export failed'); };
  img.src = url;
}
document.getElementById('exportCSV').addEventListener('click', exportCSV);
document.getElementById('sheetExportCSV').addEventListener('click', exportCSV);
document.getElementById('exportPNG').addEventListener('click', exportPNG);
document.getElementById('sheetExportPNG').addEventListener('click', exportPNG);

/* ---------- accessibility helpers ---------- */
const liveRegion = document.createElement('div');
liveRegion.setAttribute('aria-live','polite');
liveRegion.className = 'sr-only';
document.body.appendChild(liveRegion);
function announce(msg){ liveRegion.textContent = msg; }

/* keyboard helpers */
document.addEventListener('keydown', (e)=>{
  if (e.key === 'Escape' && !sheet.hidden) closeSheet();
  if (e.key === '?') alert('Tips:\n• Focus the chart and use Arrow keys to change selection.\n• Hover a slice or legend item to view details in the bottom panel.\n• Use the gear (bottom-right) to open the table and exports.\n• Edits save automatically.');
});

/* small helper */
function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

/* ---------- initial render ---------- */
render();
announce('Chart initialized.');

/* debug helper */
window.__dailyActivity = { resetLocal: ()=>{ localStorage.removeItem(KEY); location.reload(); } };
</script>
</body>
</html>
